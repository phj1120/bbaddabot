# 디스코드 공부 시간 관리 봇

## TODO

변경 전 : 채널 이동 시 공부 시간 업데이트

변경 후 : 채널 이동 시 채널 이동 기록 추가 + 공부 시간 조회 시 채널 이동 기록에서 공부한 시간 추출

교수님 출근 관리 시스템 보고 아이디어 얻음

웹 페이지 언제 부터 언제까지 했는지 보이도록

주간

```
월화수목금토일
1
~
22
 ~
 3
```

월간

```
  .
 .
.  .
123456789....xx
월간 공부시간 그래프로
+ 일 클릭 시 일정 조회, 공부 내용 추가 가능한 모달창
```

공부 채널에 머무른 시간

휴식 채널에 머무른 시간

사용자는 이런식으로 무슨 공부 했는지 추가 가능하고

관리자는 공부 기록까지 추가 가능하도록, 채널 타입 지정 가능한 페이지 제작 이름, 타입, 채널Id

## 프로젝트 소개

스터디 인원 관리를 위한 봇

각자 목표를 정해서 (하루 n 시간 씩 일주일에 m 번)

이를 지키지 못한 사람은 스터디에서 강퇴.

## 프로젝트 하며 보람 찼던 점

### Connection 문제 해결(2022.04.22.)

- 상황

한 달 정도 잘 사용 하다가 갑자기 봇이 죽음

- 원인 분석

로그 : 쿼리를 못 해 nil 값을 받고 거기서 값을 읽어 오려해 오류 발생

-> DB 문제로 판단하고 DB 관련 설정을 확인

- 해결 과정

과거에도 20번 정도 채널 이동 하면 동일한 이유로 봇이 죽은 적이 있었음.

-> 눈에 보이는 문제가 해결 되어 완전히 해결 된 줄 알았음

[기록](https://parkhj.notion.site/f8e947088da94cbe8305cd23ce76e676)

코드에 익숙해지고 보니 각 메서드마다 connection 을 생성하는 비효율적인 방식으로 구동 되고 있었음.

그래서 이번에 오류 발생

DB 연결을 Singleton 으로 바꿔 위의 문제 해결.

하지만 네트워크가 끊기거나 DB Connection 연결 시간이 지나면

한 번만 connection 을 생성하기 때문에 그 다음부터는 오류가 나지 않을까? 생각.

-> DB에 ping 을 보내 연결을 확인하고 연결안 되어있으면 다시 연결하도록 수정

직접 mysql 을 끄고 실행해보니 처음 싱글톤으로 생성한 것은 오류가 났지만

연결 여부를 확인 한 코드는 오류가 안 남.

- 한 단계 더?

값을 못 읽어 왔을 때의 예외 처리가 부족했기에 이번 오류가 생긴 것 같음.

개발 할 때 더 많이 공부하고 생각 해야 할 듯.

[기록](https://parkhj.notion.site/Connection-select-nil-b1cc49b838964f52a58e3f7f7f7b346e)

### 사용자가 있는 서비스 경험

같이 스터디 하는 친구들의 공부 시간이 초반에 비해 많이 늘어 남.

( 퍼센트 계산 해보기. )

내가 만든 기능을 누군가가 사용하는 것을 보며 뿌듯하고

어떻게 하면 더 편하게 사용 할 수 있을까? 고민하게 됨

- 예시

공부 시간 확인 할 수 있는 방법을 보기 편하게 개선

처음 : 이동 기록 전부를 한 채널에 전송

-> 여러 메시지들이 섞여 있어 보기 불편

```
20220401 22:30:05 박현준 91 분 공부 / 이동 : 개인 -> 휴식
20220401 22:35:40 박현준 5 분 휴식 / 이동 : 휴식 -> 개인
```

1차 개선

메시지 가독성 개선

```
| 20220422 22:36:39 | 박현준 휴식 | 33 분 |  이동 : 휴식 -> 개인 |
| 20220422 22:36:48 | 박현준 공부 | 0 분 / 5 시간 49 분 |  종료 : 개인 |
```

2차 개선

기존의 방식에 공부 시간을 더 편하게 확인 할 수 있도록 채널 분리

```
// 10분 이상의 공부 기록만
[ 20220422 00:30 ] 박현준 : 11 분 / 22 분
```

이렇듯 사소하지만 개선하고 싶은 부분과 추가하고 싶은 부분을 적어두고 취미로 개발하는 중

### git 경험

혼자 개발할 때는 항상 git add . / git commit -m ~ / git push 반복이 었는데

기능별로 branch 생성 -> pull request -> main branch 에 merge 하는 과정을 경험해봄.

이래서 깃을 쓰는구나 감탄함.

commit 메시지도 전에는 나만의 룰은 있었는데 통일되지 못한 느낌이 있었음

같이 개발하는 친구가 알려준 덕분에 커밋 메시지가 보기 편해진 듯 함.

- 기존 커밋 메시지

```
DB(channel type) 값 수정 및 챗봇 수정

챗 봇 기능 추가(정보 확인)
```

- 새로운 커밋 메시지

```
Add chatbot command total study time by period

Refactor code and Add commen
```

[참고한 깃 컨벤션](https://blog.ull.im/engineering/2019/03/10/logs-on-git.html)

## 계층 구조

```
* Datastruct
    - DB 테이블 속성에 맞는 타입 선언 계층

    - channel / history / studyTotal / user

* persistence
    - DB 테이블 데이터에 접근하는 계층

    - dbconn / channelDao / histotyDao / studyTotalDao / userDao

* business
    - 비즈니스 로직이 담겨있는 계층

    - persistence 의 메서드 동작 여부 테스트

    - changeChannel / chatbot / throwOut / test

*  presentation
    - 사용자로부터 데이터를 받아 서비스를 제공하는 계층

    - bbaddabot
```

## 사용법

### 봇 초대

https://discord.com/oauth2/authorize?client_id=951796816016445464&permissions=8&scope=bot

### 초기 설정

```
!설정 채팅채널 기록 : 특정 시간에 알림이 올 채널으로 지정

!설정 채팅채널 로그 : 공부 시간 받을 채널 지정

// 아래는 추후 추가 예정
!설정 음성채널 공부 채널ID : 공부 채널로 지정(음성 채널)

!설정 음성채널 휴식 채널ID : 휴식 채널로 지정(음성 채널)
```

### 정보 확인

```
!기록 : 전체 인원

!공부시간 : 본인 공부 시간 확인

!일 : 오늘 공부한 시간 확인

!주: 이번 주에 공부한 시간 확인

!달: 이번 달에 공부한 시간 확인

```

### 기준

```
하루 : 0 ~ 24 시

주간 : 월 ~ 일

공부시간 : 공부 채널과 휴식 채널로 나뉘어 공부 채널에 머무른 시간을 공부 시간으로 측정
```

### 기타

```
채널 이동 할 때마다 시간 기록 되는 거라 기준시간(00시) 전에

한 번 왔다 갔다 해줘야 오늘 기록에 인정, 아니면 다음날에 기록 됨
```

### 추후 수정 사항

```
공부 시간, 횟수 기준 변경 (일간, 통합 -> 주간, 개인별)

하루 기준 변경 ( 현재 00시 -> n 시 )
```

### 개발 계획

```
추가 되면 좋겠다 싶은 아이디어, 사용 중 버그 제보 받음

하고 싶을 때 개발은 틈틈히 할 예정
```

## 개발 과정

### 환경 구성

- 필요 모듈 다운로드

```
go mod tidy
```

- 실행

```
go run .
```

### 참고 자료

Go

- https://go.dev/doc/tutorial/getting-started

Discordgo

- https://pkg.go.dev/github.com/bwmarrin/discordgo#section-readme

Go layered Arcitecture

- https://github.com/ruslantsyganok/clean_arcitecture_golang_example

### 기록

https://parkhj.notion.site/da3f8fe5a214450386461b4e2f7f33e6
