# 디스코드 공부 시간 관리 봇

## 프로젝트 소개

스터디 인원 관리를 위한 봇

각자 목표를 정해서 (하루 n 시간 씩 일주일에 m 번)

이를 지키지 못한 사람은 스터디에서 강퇴.

## 프로젝트 하며 보람 찼던 점

- Connection 문제 해결(2022.04.22.)

2주 정도 잘 사용 하다가 갑자기 봇이 죽었다.

로그를 보니 nil 에서 값을 읽어 오려해 오류 발생 했다.

쿼리를 못 해온거니까 DB 문제라고 판단해 DB 관련 설정을 확인 했다.

과거에도 20번 정도 채널 이동 하면 동일한 이유로 봇이 죽은 적이 있다.

그래서 메서드 마다 defer db.Close() 를 추가해주고나서 눈에 보이는 문제가 해결 되어 완전히 해결 된 줄 알았다.

하지만 지나고 보니 각 메서드마다 connection 을 생성하는 비효율적인 방식으로 구동되고 있었다.

그래서 이번에 오류가 생겼다.

DB 연결을 Singleton 으로 바꿔 위의 문제는 해결 했다.

하지만 네트워크나 DB Connection 연결 시간이 지나면 sigleton 이기 때문에

그 다음부터는 오류가 나지 않을까? 라는 생각을 했다.

그래서 DB에 ping 을 보내 연결을 확인하고 연결안 되어있으면 다시 연결하도록 코드를 수정했다.

직접 mysql 을 끄고 실행해보니 싱글톤으로 생성한 것은 오류가 났지만 연결 여부를 확인 한 코드는 오류가 안 났다.

https://parkhj.notion.site/Connection-select-nil-b1cc49b838964f52a58e3f7f7f7b346e

- 사용자가 있는 서비스 경험

저 뿐만 아니라 같이 스터디 하는 친구들의 공부 시간이 초반에 비해 많이 늘어 났습니다. ( 퍼센트 계산 해보기. )

이것도 뿌듯 했지만 제가 만든 기능을 누군가가 사용하는 것을 보면서 어떻게 하면 더 편하게 사용 할 수 있을까? 고민하게 되었습니다.

예시로 공부 시간 확인 할 수 있는 방법을 보기 편하게 개선 했습니다.

처음엔 이동 기록 전부를 한 채널에 보냈었습니다.

여러 메시지들이 섞여 있어 보기 불편했습니다.

```
20220401 22:30:05 박현준 91 분 공부 / 이동 : 개인 -> 휴식
20220401 22:35:40 박현준 5 분 휴식 / 이동 : 휴식 -> 개인
```

메시지를 좀 더 편하게 볼 수 있도록 개선했습니다.

```
| 20220422 22:36:39 | 박현준 휴식 | 33 분 |  이동 : 휴식 -> 개인 |
| 20220422 22:36:48 | 박현준 공부 | 0 분 / 5 시간 49 분 |  종료 : 개인 |
```

기존의 방식에 공부 시간을 더 편하게 확인 할 수 있도록

일정 시간 이상의 공부 시간을 보내주는 채널을 추가했습니다.

```
[ 20220422 00:30 ] 박현준 : 11 분 / 22 분
```

이렇듯 사소하지만 개선하고 싶은 부분과 추가하고 싶은 것을 계속 적어두고 취미로 개발하고 있습니다.

## 계층 구조

```
* Datastruct
    - DB 테이블 속성에 맞는 타입 선언 계층

    - channel / history / studyTotal / user

* persistence
    - DB 테이블 데이터에 접근하는 계층

    - dbconn / channelDao / histotyDao / studyTotalDao / userDao

* business
    - 비즈니스 로직이 담겨있는 계층

    - persistence 의 메서드 동작 여부 테스트

    - changeChannel / chatbot / throwOut / test

*  presentation
    - 사용자로부터 데이터를 받아 서비스를 제공하는 계층

    - bbaddabot
```

## 사용법

### 봇 초대

https://discord.com/oauth2/authorize?client_id=951796816016445464&permissions=8&scope=bot

### 초기 설정

```
!설정 채팅채널 기록 : 특정 시간에 알림이 올 채널으로 지정

!설정 채팅채널 로그 : 공부 시간 받을 채널 지정

// 아래는 추후 추가 예정
!설정 음성채널 공부 채널ID : 공부 채널로 지정(음성 채널)

!설정 음성채널 휴식 채널ID : 휴식 채널로 지정(음성 채널)
```

### 정보 확인

```
!기록 : 전체 인원

!공부시간 : 본인 공부 시간 확인

```

### 기준

```
하루 = 0 ~ 24 시

공부시간 = 공부 카테고리 채널에 머무른 시간
```

### 기타

```
채널 이동 할 때마다 시간 기록 되는 거라 기준시간(00시) 전에
한 번 왔다 갔다 해줘야 오늘 기록에 인정, 아니면 다음날에 기록 됨
```

### 추후 수정 사항

```
공부 시간, 횟수 기준 변경 (일간, 통합 -> 주간, 개인별)

하루 기준 변경 ( 현재 00시 -> n 시 )
```

### 개발 계획

```
추가 되면 좋겠다 싶은 아이디어, 사용 중 버그 제보 받음

하고 싶을 때 개발은 틈틈히 할 예정
```

## 개발 과정

### 환경 구성

- 필요 모듈 다운로드

```
go mod tidy
```

- 실행

```
go run .
```

### 참고 자료

Go

- https://go.dev/doc/tutorial/getting-started

Discordgo

- https://pkg.go.dev/github.com/bwmarrin/discordgo#section-readme

Go layered Arcitecture

- https://github.com/ruslantsyganok/clean_arcitecture_golang_example

### 기록

https://parkhj.notion.site/da3f8fe5a214450386461b4e2f7f33e6
